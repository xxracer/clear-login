
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    /**
     * Gets the user's profile document from the /users collection.
     */
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    /**
     * Checks if the authenticated user has a specific role.
     */
    function hasRole(role) {
      let userProfile = getUserProfile();
      return userProfile.data.role == role;
    }
    
    /**
     * Checks if a resource belongs to the same company as the user.
     * Assumes the resource has a 'companyId' field.
     */
    function isFromSameCompany(resource) {
       let userProfile = getUserProfile();
       return resource.data.companyId == userProfile.data.companyId;
    }

    /**
     * Ensures a document exists before an update or delete operation.
     */
    function isExistingDocument() {
      return resource != null;
    }

    /**
     * On create, validates that the document's internal 'id'
     * matches the document ID in the path.
     */
    function isIdConsistentOnCreate(docId) {
      return request.resource.data.id == docId;
    }

    /**
     * On update, ensures the document's internal 'id' is immutable.
     */
    function isIdImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * On create, validates that a subcollection document has a 'candidateId'
     * field that correctly links it to its parent candidate document.
     */
    function isLinkedToParentOnCreate(candidateId) {
      return request.resource.data.candidateId == candidateId;
    }

    /**
     * On update, ensures the 'candidateId' linking a subcollection document
     * to its parent is immutable.
     */
    function isParentLinkImmutable() {
      return request.resource.data.candidateId == resource.data.id;
    }


    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Manages user profiles. Users can only read their own profile.
     *              Admins can create users for their company. Superadmins can list users.
     * @path        /users/{userId}
     */
    match /users/{userId} {
      allow list: if isSignedIn();
      allow read: if isSignedIn() && request.auth.uid == userId;
      // Allow create for any signed-in user (superuser creates admins, company admins will create employees)
      allow create: if isSignedIn();
      allow update: if isSignedIn() && request.auth.uid == userId; // Users can update their own profile
      allow delete: if isSignedIn(); // Superuser can delete any user
    }

    /**
     * @description Manages candidate records. Any authenticated user (HR staff) can
     *              create, view, and manage all candidate profiles within their company.
     * @path        /candidates/{candidateId}
     */
    match /candidates/{candidateId} {
      allow read, list: if isSignedIn(); // Simplified for now, will add company check later
      allow create: if isSignedIn() && isIdConsistentOnCreate(candidateId);
      allow update: if isSignedIn() && isExistingDocument() && isIdImmutable();
      allow delete: if isSignedIn() && isExistingDocument();

      /**
       * @description Manages the onboarding phases for a specific candidate.
       * @path        /candidates/{candidateId}/onboardingPhases/{onboardingPhaseId}
       */
      match /onboardingPhases/{onboardingPhaseId} {
        allow read, list: if isSignedIn();
        allow create: if isSignedIn() && isLinkedToParentOnCreate(candidateId);
        allow update: if isSignedIn() && isExistingDocument() && isParentLinkImmutable();
        allow delete: if isSignedIn() && isExistingDocument();
      }

      /**
       * @description Manages documents associated with a specific candidate.
       * @path        /candidates/{candidateId}/documents/{documentId}
       */
      match /documents/{documentId} {
        allow read, list: if isSignedIn();
        allow create: if isSignedIn() && isLinkedToParentOnCreate(candidateId);
        allow update: if isSignedIn() && isExistingDocument() && isParentLinkImmutable();
        allow delete: if isSignedIn() && isExistingDocument();
      }

      /**
       * @description Manages notifications related to a specific candidate's progress.
       * @path        /candidates/{candidateId}/notifications/{notificationId}
       */
      match /notifications/{notificationId} {
        allow read, list: if isSignedIn();
        allow create: if isSignedIn() && isLinkedToParentOnCreate(candidateId);
        allow update: if isSignedIn() && isExistingDocument() && isParentLinkImmutable();
        allow delete: if isSignedIn() && isExistingDocument();
      }
    }
  }
}
